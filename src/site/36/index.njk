{% block head %}
  <script src="./two.min.js"></script>
  <script>
    let two;

    function getPositions(angle, orbit) {
      return {
        x: Math.cos(angle * Math.PI / 180) * orbit,
        y: Math.sin(angle * Math.PI / 180) * orbit
      };
    }

    function rnd(max) {
      return Math.floor(Math.random() * max - max/2);
    }

    function makeSubCircles(group, x, y, r, color) {
      const subCircles = [];
      for (let i = 0; i < 10; i++) {
        const x_rnd = x + rnd(r/5);
        const y_rnd = y + rnd(r/10);
        const c = two.makeCircle(x_rnd, y_rnd, r/2 + rnd(r/2));
        c.fill = "transparent";
        c.stroke = color;
        c.linewidth = 6 + rnd(5);
        c.x = x_rnd;
        c.y = y_rnd;

        group.add(c);
        subCircles.push(c);
      }

      return subCircles;
    }

    function moveSubs(subs, x, y) {
      let ndx = 0;
      for (const c of subs) {
        if (ndx % 2 === 0) {
          c.translation.x = c.x + x / 2 + ndx * 4;
          c.translation.y = c.y + y / 2 + ndx * 2;
        }
        else {
          c.translation.x = c.x - x / 2 + ndx * 4;
          c.translation.y = c.y - y / 2 + ndx * 2;
        }
        ndx += 1;
      }
    }

    ready(() => {
      // Make an instance of two and place it on the page.
      const elem = document.getElementById('playground');
      two = new Two({
        fullscreen: true,
        antialias: true
      }).appendTo(elem);

      const background = two.makeGroup();
      const foreground = two.makeGroup();

      const numX = 4;
      const numY = 3;

      const deltaX = two.width / numX;
      const deltaY = two.height / numY;

      let radius = deltaX * 0.6;
      if (deltaY * 0.6 > radius) {
        radius = deltaY * 0.6;
      }

      const circles = [];
      let text;
      let yellowCircle;

      let count = 0;
      for (let y = 0; y <= numY; y++) {
        for (let x = 0; x <= numX; x++) {
          const pointX = x * deltaX;
          const pointY = y * deltaY;
          const circle = two.makeCircle(pointX, pointY, radius);
          if (count % 2 === 0) {
            circle.fill = '#df0025';
          } else {
            circle.fill = '#08b1df';
          }
          const currentCircle = {
            circle: circle,
            x: pointX,
            y: pointY,
            a: 0,
            i: count
          };

          circles.push(currentCircle);

          if (count === 13) {
            foreground.add(circle);
            circle.fill = '#f8c428';
            yellowCircle = circle;
            text = two.makeText("YOU", pointX, pointY);
            text.size = 26;
            text.weight = 700;
            text.fill = '#fff';
            text.family= "Lato";
          } else {
            background.add(circle);
            currentCircle.subs = makeSubCircles(background, pointX, pointY, radius, circle.fill);
          }
          count += 1;
          circle.opacity = 0.8;
          circle.noStroke();
        }
      }

      let clicked = false;
      // Don't forget to tell two to render everything to the screen
      two.update();
      yellowCircle._renderer.elem.addEventListener('click', () => {
        clicked = !clicked;
      }, false);

      two.bind('update', frameCount => {
        let count = 0;
        for (c of circles) {
          const pos = getPositions((c.a * c.i) / 2, 30);
          c.a += 1;
          if (count === 13) {
            c.circle.translation.x = c.x - pos.x;
            c.circle.translation.y = c.y + pos.y;
          }
          else {
            c.circle.translation.x = c.x + pos.x;
            c.circle.translation.y = c.y + pos.y;
            moveSubs(c.subs, pos.x, pos.y);
            if (clicked) {
              c.circle.opacity = 0.1;
              for (const cc of c.subs) {
                cc.visible = false;
              }
              text.visible = false;
            }
            else {
              c.circle.opacity = 0.8;
              for (const cc of c.subs) {
                cc.visible = true;
              }
              text.visible = true;
            }
          }
          count += 1;
        }

      }).play();

    });
  </script>
{% endblock %}
{% block main %}

  <div id="playground" style="width: 100%; height: 100vh;">

  </div>

{% endblock %}
